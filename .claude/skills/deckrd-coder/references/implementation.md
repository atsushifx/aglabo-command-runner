---
title: IMPLEMENTATION - 厳格な実装フロー
---

## IMPLEMENTATION - タスク委譲オーケストレーション

> **Note**: このドキュメントは **実装モード** の詳細手順を記述しています。
> 検索モード（アクティブセッションが空白または実装済みの場合）については、[coding.md](../commands/coding.md) を参照してください。

## 全体フロー概要

実装の責務は **タスクリストの管理とbdd-coderへの委譲** です。個別の Red-Green-Refactor サイクルは bdd-coder が完全に実行します。

```text
Step 1: 品質ゲート用コマンド取得
    ↓
Step 2: 実装タスクリスト読み込み
    ↓
Step 3: 次の未実装タスクを抽出
    ↓
Step 4: bdd-coder エージェントに委譲
    │  (bdd-coder が Red-Green-Refactor を自動実行)
    │  (実装完了時に自動で返却)
    ↓
Step 5: 完了タスクを記録
    ├─ tasks.md でタスクを [x] にマーク
    └─ TodoWrite で進捗同期
    ↓
Step 6: 繰り返し判定
    ├─ 未実装タスク存在: Step 3 へ戻る
    └─ すべて完了: Step 7 へ進む
    ↓
Step 7: 品質ゲート実行 (全体検証)
    ↓
Step 8: Refactor フェーズ (必要に応じて)
    ↓
Step 9: 完了判定
```

## 核心原則

1. **責務分離の徹底**: 実装フロー = タスク管理＋委譲、テスト実装＝bdd-coder 専担
2. **単一タスク原則**: bdd-coder は 1 タスク専用、完了まで待機（並行実行禁止）
3. **完全な委譲**: bdd-coder に指示したら Red-Green-Refactor は任せる（途中干渉なし）
4. **即座の記録**: bdd-coder 完了直後に tasks.md を更新（進捗の可視化）
5. **品質ゲート必須**: Step 7 実施は必須（3回以上失敗時、ユーザーに相談）
6. **全体統合 Refactor**: Step 8 でコード品質を統合的に改善（ユーザー相談必須）
7. **明確な完了条件**: Step 9 のすべてのチェック項目を満たす必要あり

---

## 詳細ステップ

### ステップ 1: 品質ゲート用のコマンドを取得する

目的: プロジェクト固有の品質ゲートコマンドを事前に取得。

実行内容:

1. `package.json` / `setup.py` / `Cargo.toml` などをもとに、以下のコマンドを取得
   - Lint チェック: `npm run lint` / `python -m flake8` など
   - 型チェック: `tsc --noEmit` / `mypy` / `pyright` など
   - テスト実行: `npm run test` / `pytest` など
2. 各コマンドが実行可能であることを確認
3. 取得したコマンドを後続ステップで使用するため記録

チェックリスト:

- [ ] Lint コマンド確認
- [ ] 型チェックコマンド確認
- [ ] テスト実行コマンド確認

---

### ステップ 2: パラメータをもとに実装タスクリストを取得する

目的: セッション・パラメータから実装タスクを細分化・リスト化。

> **前提条件**: このステップは実装モードで実行されます。
> アクティブセッションが空白または実装済みの場合は、検索モード（coding.md 参照）が先に実行され、有効なタスク ID が確認されています。

実行内容:

#### 1. セッションファイルの読み込み

`deckrd-coder` が保存・参照するセッション情報は **`docs/.deckrd/coder.session`** から取得:

```bash
# セッションファイル読み込み (.env 形式)
DECKRD_SESSION_TITLE=...
DECKRD_SESSION_STATUS=Active
DECKRD_ACTIVE_SESSION=T01-08        # ← アクティブタスク
DECKRD_TASK_FILE=docs/.deckrd/.../tasks.md  # ← タスク定義ファイル
```

#### 2. タスク ID の決定

実装モードに到達する時点で、以下が保証されています。

- パラメータが指定されている。
- `DECKRD_ACTIVE_SESSION` が有効な未実装タスク ID に設定されている (検索モードで検証済み)

したがって、**パラメータから Task ID を取得** します。

- パラメータで指定された場合: 指定された Task ID を使用
- パラメータなしの場合: `DECKRD_ACTIVE_SESSION` の値を使用 (有効性はすでに確認済み)

#### 3. タスク定義ファイルの読み込み

`DECKRD_TASK_FILE` から指定タスク ID に対応するテストケース一覧を抽出:

```markdown
- [ ] Task 1: 入力値が有効な場合、結果 A を返す (正常系)
- [ ] Task 2: 入力値が null の場合、エラーを返す (異常系)
- [ ] Task 3: 入力値が空文字列の場合、デフォルト値を返す (エッジケース)
```

#### 4. 要件の細分化

1. 抽出したテストケースを分析し、単一テストケース単位のタスクに分割
2. 各タスクの依存関係を把握
3. **実装タスクリスト** を作成

チェックリスト:

- [ ] セッションファイルから正確に情報を取得
- [ ] タスク ID が正確に決定されている
- [ ] タスク定義ファイルから対応するタスク内容を抽出
- [ ] タスクが十分に細分化されている (1 test = 1 task の原則)
- [ ] 各タスクは独立している
- [ ] 依存関係が明確

---

### ステップ 3: 次の未実装タスクを抽出

目的: タスクリストから実装対象を特定。

実行内容:

1. 実装タスクリストを確認
2. **最初の未実装タスク** を特定（[ ] 状態）
3. そのタスクの詳細内容を抽出
   - タスク ID
   - テストケース要件
   - 依存タスク（あれば）

チェックリスト:

- [ ] 未実装タスクが特定された
- [ ] タスク内容が明確
- [ ] 依存関係が把握されている

---

### ステップ 4: bdd-coder エージェントに委譲

目的: 単一タスクを bdd-coder に委譲し、完全な実装（Red-Green-Refactor）を任せる。

実行内容:

1. **bdd-coder エージェント起動**
   - パラメータ: ステップ 3 で抽出したタスクの詳細説明
2. **委譲内容**: 以下は bdd-coder が完全に実行
   - Red フェーズ: テストケース実装 → テスト失敗確認
   - Green フェーズ: 最小実装 → テスト合格確認
   - Refactor フェーズ: 軽微な整理
3. **完了条件**: bdd-coder がタスク完了を報告（全テスト合格）

重要な制約:

- bdd-coder は **1 つのタスク専用** (複数タスク並行実行禁止)
- bdd-coder の完了判定: すべてのテストが合格状態
- bdd-coder でエラー 3 回以上の場合: ロールバック・ユーザー相談
- **途中干渉なし**: Red-Green-Refactor は bdd-coder に全面委譲

チェックリスト:

- [ ] bdd-coder エージェントが起動された
- [ ] タスク内容が正確に伝達された
- [ ] bdd-coder から完了報告を受けた
- [ ] すべてのテストが合格状態

---

### ステップ 4: 実装したタスクをチェック (新規)

目的: 完了したタスクを記録し、進捗を確定。

実行内容:

1. **tasks.md を更新** - 実装したタスクを `[x]` にマーク
2. **TodoWrite で進捗を同期**
3. セッション情報の一時更新（全体同期は Step 6 で）

チェックリスト:

- [ ] tasks.md で対象タスクをチェック済み ([x])
- [ ] TodoWrite に反映済み
- [ ] タスク状態が確定

---

### ステップ 5: 繰り返し判定

目的: すべてのタスクを実装完了するまでループ。

実行内容:

1. 実装タスクリストを確認
2. 未実装タスクが存在するか判定
   - YES: ステップ 3 へ戻る (次のタスクを実装)
   - NO: ステップ 6 へ進む

チェックリスト:

- [ ] すべてのタスクが `completed` 状態
- [ ] 未実装タスクなし

---

### ステップ 6: 状態確定と進捗記録

目的: 全体の実装状況を明確に記録。

状態確定とは、すべての完了タスクの事実を確認し、セッションを更新し、次フェーズに進む準備をするフェーズです。

実行内容:

1. **全タスク確認** - すべての実装済みタスクが tasks.md で [x] になっているか確認
2. **セッション更新** - DECKRD_ACTIVE_SESSION を次のタスク ID に更新
3. **TodoWrite 更新** - 全体の進捗状況を同期

チェックリスト:

- [ ] すべての完了タスクが tasks.md で [x] にマーク済み
- [ ] セッションファイルが更新済み（次のタスク ID に）
- [ ] TodoWrite が全体進捗を反映

---

### ステップ 7: 品質ゲート実行 (全体検証)

目的: 全体コードの品質を検証。

実行内容:

1. ステップ 1 で取得したコマンドを実行
   - Lint チェック: `npm run lint` など
   - 型チェック: `tsc --noEmit` など
   - テスト実行: `npm test` など
2. 各チェックの結果を確認
3. 失敗時の対応:
   - エラーの種類・箇所を特定
   - 対応方法を検討・修正
   - 修正後、Step 7 を再実行
   - 簡潔なコード、読みやすいコードが必要な場合は Step 8 (Refactor フェーズ) でコードを整理
   - 3 回以上失敗時: ユーザーに相談

チェックリスト:

- [ ] Lint チェック: 合格
- [ ] 型チェック: 合格
- [ ] テスト実行: すべてのテストがグリーン
- [ ] 品質ゲート: 全体合格

---

### ステップ 8: Refactor フェーズ (全体コード整理)

目的: テストコード・実装コードの読みやすさと簡潔性を向上。

実行内容:

1. **テストコードの整理**
   - テスト仕様化 (it.each など) による簡潔化
   - 重複テストの統合
   - テスト内の変数名・構造改善

2. **実装コードの整理**
   - 重複ロジックの関数抽出
   - 変数名・関数名の改善
   - 不要なコードの削除
   - 読みやすさと簡潔性のバランス最適化

3. **ユーザーとのやりとり**
   - リファクタリング案を提示
   - ユーザーの承認を得る
   - ユーザーの要望に応じて修正

4. **検証**
   - リファクタリング後、すべてのテストが合格することを確認
   - 品質ゲートが合格することを確認

チェックリスト:

- [ ] テストコードが簡潔化
- [ ] 実装コードが読みやすい
- [ ] 重複が排除されている
- [ ] すべてのテストがグリーン
- [ ] 品質ゲート合格

---

### ステップ 9: 完了判定

目的: 実装が完全に完了したことを確認。

実行内容:
以下の条件をすべて満たしているか確認:

1. **テスト完了**
   - すべてのテストケースが実装済み
   - すべてのテストがグリーン状態

2. **品質ゲート合格**
   - Lint チェック: 合格
   - 型チェック: 合格
   - その他プロジェクト固有のチェック: すべて合格

3. **Refactor 完了**
   - テストコード・実装コードの整理が完了
   - ユーザーが内容に承認

4. **進捗記録完了**
   - tasks.md がすべての完了タスクをマーク済み
   - セッションが次のタスク ID に更新済み

完了条件チェック:

- [ ] すべてのテストが `passed` 状態
- [ ] Lint チェック合格
- [ ] 型チェック合格
- [ ] テストコード Refactor 完了
- [ ] 実装コード Refactor 完了
- [ ] ユーザー承認取得
- [ ] tasks.md 完全更新
- [ ] セッション更新完了

判定結果:

- YES: 実装完了 → プロセス終了
- NO: ステップ 8 へ戻り、不足部分をリファクタリング
