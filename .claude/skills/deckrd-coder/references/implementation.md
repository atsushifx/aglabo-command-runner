---
title: IMPLEMENTATION - 厳格な実装フロー
---

## IMPLEMENTATION - タスク委譲オーケストレーション

> **Note**: このドキュメントは **実装モード** の詳細手順を記述しています。
> 検索モード (アクティブセッションが空白または実装済みの場合) については、[coding.md](../commands/coding.md) を参照してください。

## 品質ゲートの2段階構造

このスキルの品質ゲートは2つのレベルで実行されます：

1. **Phase 4 (bdd-coderエージェント内)** - 簡略版：テスト・型チェック・Lint のみ
2. **ステップ 8 (coding コマンド内)** - 全項目検証：セキュリティ・ファイル命名・スペルチェックなど全チェック含む

## 全体フロー概要

実装の責務は **tasks.md からタスクを取得して bdd-coder へ委譲** することです。個別の Red-Green-Refactor サイクルは bdd-coder が完全に実行します。

```text
Step 1: 品質ゲート用コマンド取得
    ↓
Step 2: tasks.md から未チェックのタスクを取得
    ↓
Step 3: tasks.md上の1タスク (1行) をタスクID(Full)とタスク詳細に分解
    ↓
Step 4: bdd-coder エージェントに委譲
    │  (bdd-coder が Red-Green-Refactor を自動実行)
    │  (実装完了時に自動で返却)
    ↓
Step 5: 完了タスクを記録
    ├─ tasks.md でタスクを [x] にマーク
    └─ TodoWrite で進捗同期
    ↓
Step 6: 繰り返し判定
    ├─ 未実装タスク存在: Step 2 へ戻る
    └─ すべて完了: Step 7 へ進む
    ↓
Step 7: 状態確定と進捗記録
    ↓
Step 8: 品質ゲート実行 (全体検証)
    ↓
Step 9: Refactor フェーズ (必要に応じて)
    ↓
Step 10: 完了判定
```

## 核心原則

1. **責務分離の徹底**: 実装フロー = タスク管理＋委譲、テスト実装＝bdd-coder 専担
2. **単一タスク原則**: bdd-coder は 1 タスク専用、完了まで待機 (並行実行禁止)
3. **完全な委譲**: bdd-coder に指示したら Red-Green-Refactor は任せる (途中干渉なし)
4. **即座の記録**: bdd-coder 完了直後に tasks.md を更新 (進捗の可視化)
5. **品質ゲート必須**: Step 7 実施は必須 (3回以上失敗時、ユーザーに相談)
6. **全体統合 Refactor**: Step 8 でコード品質を統合的に改善 (ユーザー相談必須)
7. **明確な完了条件**: Step 9 のすべてのチェック項目を満たす必要あり

---

## 詳細ステップ

### ステップ 1: 品質ゲート用のコマンドを取得する

目的: プロジェクト固有の品質ゲートコマンドを事前に取得。

実行内容:

1. `package.json` / `setup.py` / `Cargo.toml` などをもとに、以下のコマンドを取得
   - Lint チェック: `npm run lint` / `python -m flake8` など
   - 型チェック: `tsc --noEmit` / `mypy` / `pyright` など
   - テスト実行: `npm run test` / `pytest` など
2. 各コマンドが実行可能であることを確認
3. 取得したコマンドを後続ステップで使用するため記録

チェックリスト:

- [ ] Lint コマンド確認
- [ ] 型チェックコマンド確認
- [ ] テスト実行コマンド確認

---

### ステップ 2: tasks.md から未チェックのタスクを取得する

目的: tasks.md から最初の未実装タスク (1行) を取得

> **前提条件**: このステップは実装モードで実行されます。
> アクティブセッションが空白または実装済みの場合は、検索モード (coding.md 参照) が先に実行され、有効なタスク ID が確認されています。

実行内容:

#### 1. セッション情報の確認

`deckrd-coder` が参照するセッション情報から tasks.md ファイルパスを取得:

```bash
# セッションファイル (.env 形式)
DECKRD_TASK_FILE=docs/.deckrd/.../tasks.md  # ← タスク定義ファイル
```

#### 2. tasks.md から未チェックのタスクを取得

`DECKRD_TASK_FILE` に記載された tasks.md を開き、**最初の未実装タスク** ([ ] 状態) を探す：

```markdown
- [x] T01-01: 既に実装済み
- [ ] T01-02: タスク詳細 Given:... / When:... / Then:... ← このタスクを取得
- [ ] T01-03: 別のタスク
```

**重要**: tasks.md の 1 行のタスク記述をそのまま使用します。細分化やテストケース分割は行いません。

チェックリスト:

- [ ] セッションファイルからタスク定義ファイルパスを取得
- [ ] tasks.md を開いた
- [ ] 最初の未実装タスク ([ ] 状態) を特定
- [ ] タスクの 1 行記述を完全にコピー

---

### ステップ 3: タスク行をタスクID(Full)とタスク詳細に分解

目的: ステップ 2 で取得した tasks.md の 1 行を、**タスク ID (フル) **と**タスク詳細**に分解。

実行内容:

1. ステップ 2 で取得したタスク行 (1 行分) を解析
2. タスク行のフォーマット: `- [ ] **TaskID**: Task Detail`
3. **タスク ID (フル) **と**タスク詳細**を抽出

**分解例**:

```markdown
tasks.md から取得した行：

- [ ] **T01-02-03**: タスク詳細 Given:... / When:... / Then:...

分解結果：
Task ID (Full): T01-02-03
Task Detail: タスク詳細 Given:... / When:... / Then:...
```

チェックリスト:

- [ ] タスク行を正確に解析
- [ ] **タスク ID (フル) を抽出** (例: T01-02-03)
- [ ] **タスク詳細を抽出** (Given/When/Then や説明文)
- [ ] 両方の情報が正確に取得されている

---

### ステップ 4: bdd-coder エージェントに委譲

目的: ステップ 3 で分解した**タスク ID (フル) **と**タスク詳細**を bdd-coder に委譲し、完全な実装 (Red-Green-Refactor) を任せる。

実行内容:

1. **ステップ 3 で分解したタスク情報を確認**

   - **タスク ID (フル) **: ステップ 3 で抽出したフルな ID
     - 例: `T01-02-03`

   - **タスク詳細**: ステップ 3 で抽出した詳細説明
     - 例: `タスク詳細 Given:... / When:... / Then:...`

2. **bdd-coder エージェント起動 - パラメータ明示**

   抽出したタスク情報を bdd-coder に**明示的なパラメータ**として渡す:

   ```
   Task Agent: bdd-coder
   Task ID: T01-02-03
   Task Detail: タスク詳細 Given:... / When:... / Then:...
   ```

3. **委譲内容**: 以下は bdd-coder が完全に実行
   - Red フェーズ: テストケース実装 → テスト失敗確認
   - Green フェーズ: 最小実装 → テスト合格確認
   - Refactor フェーズ: 軽微な整理
   - 簡略版品質ゲート: テスト・型チェック・Lint 合格確認

4. **完了条件**: bdd-coder がタスク完了を報告 (全テスト合格)

重要な制約:

- bdd-coder は **1 つのタスク専用** (複数タスク並行実行禁止)
- **パラメータは明示的に渡す**: タスク ID (フル) とタスク詳細は呼び出し時に必ず明記
- bdd-coder の完了判定: すべてのテストが合格状態
- bdd-coder でエラー 3 回以上の場合: ロールバック・ユーザー相談
- **途中干渉なし**: Red-Green-Refactor は bdd-coder に全面委譲

チェックリスト:

- [ ] ステップ 3 で分解したタスク情報を確認した
- [ ] **タスク ID (フル) を明示的に取得した** (例: T01-02-03)
- [ ] **タスク詳細を明示的に取得した** (ステップ 3 から完全にコピー)
- [ ] bdd-coder エージェントに**パラメータを明示的に渡した**
- [ ] bdd-coder から完了報告を受けた
- [ ] すべてのテストが合格状態

---

### ステップ 5: 実装したタスクをチェック

目的: 完了したタスクを記録し、進捗を確定。

実行内容:

1. **tasks.md を更新** - 実装したタスクを `[x]` にマーク
2. **TodoWrite で進捗を同期**
3. セッション情報の一時更新 (全体同期は Step 6 で)

チェックリスト:

- [ ] tasks.md で対象タスクをチェック済み ([x])
- [ ] TodoWrite に反映済み
- [ ] タスク状態が確定

---

### ステップ 6: 繰り返し判定

目的: すべてのタスクを実装完了するまでループ。

実行内容:

1. tasks.md を確認
2. 未実装タスク ([ ] 状態) が存在するか判定
   - YES: ステップ 2 へ戻る (次のタスクを実装)
   - NO: ステップ 7 へ進む

チェックリスト:

- [ ] すべてのタスクが `completed` 状態
- [ ] 未実装タスクなし

---

### ステップ 7: 状態確定と進捗記録

目的: 全体の実装状況を明確に記録。

状態確定とは、すべての完了タスクの事実を確認し、セッションを更新し、次フェーズに進む準備をするフェーズです。

実行内容:

1. **全タスク確認** - すべての実装済みタスクが tasks.md で [x] になっているか確認
2. **セッション更新** - DECKRD_ACTIVE_SESSION を次のタスク ID に更新
3. **TodoWrite 更新** - 全体の進捗状況を同期

チェックリスト:

- [ ] すべての完了タスクが tasks.md で [x] にマーク済み
- [ ] セッションファイルが更新済み (次のタスク ID に)
- [ ] TodoWrite が全体進捗を反映

---

### ステップ 8: 品質ゲート実行 (全体検証)

目的: 全体コードの品質を**全項目で**検証 (bdd-coder内の簡略版ではなく完全版) 。

> **重要**: このステップは coding コマンド (deckrd-coderスキル) で全タスク実装後に実行されるもので、bdd-coderエージェント内での品質ゲート (テスト・型・Lint のみ) とは異なります。

実行内容:

ステップ 1 で取得したコマンドを全て実行:

1. **実装コード品質チェック**
   - Lint チェック: `pnpm lint` など
   - 型チェック: `pnpm check:types` など
   - テスト実行: `pnpm test` など

2. **コード整形・スタイル**
   - コード整形チェック: `pnpm check:dprint` など

3. **セキュリティ・メタデータ**
   - セキュリティスキャン: `pnpm lint:secrets` など
   - ファイル命名規約: `pnpm lint:filenames` など
   - スペルチェック: `pnpm check:spells` など
   - テキスト品質: `pnpm lint:text`, `pnpm lint:markdown` など

4. 各チェックの結果を確認
5. 失敗時の対応:
   - エラーの種類・箇所を特定
   - 対応方法を検討・修正
   - 修正後、Step 8 を再実行
   - 簡潔なコード、読みやすいコードが必要な場合は Step 9 (Refactor フェーズ) でコードを整理
   - 3 回以上失敗時: ユーザーに相談

チェックリスト:

- [ ] Lint チェック: 合格
- [ ] 型チェック: 合格
- [ ] テスト実行: すべてのテストがグリーン
- [ ] セキュリティスキャン: 合格
- [ ] ファイル命名規約: 合格
- [ ] スペルチェック: 合格
- [ ] テキスト品質: 合格
- [ ] コード整形: 合格
- [ ] 品質ゲート: 全項目合格

---

### ステップ 9: Refactor フェーズ (全体コード整理)

目的: テストコード・実装コードの読みやすさと簡潔性を向上。

実行内容:

1. **テストコードの整理**
   - テスト仕様化 (it.each など) による簡潔化
   - 重複テストの統合
   - テスト内の変数名・構造改善

2. **実装コードの整理**
   - 重複ロジックの関数抽出
   - 変数名・関数名の改善
   - 不要なコードの削除
   - 読みやすさと簡潔性のバランス最適化

3. **ユーザーとのやりとり**
   - リファクタリング案を提示
   - ユーザーの承認を得る
   - ユーザーの要望に応じて修正

4. **検証**
   - リファクタリング後、すべてのテストが合格することを確認
   - 品質ゲートが合格することを確認

チェックリスト:

- [ ] テストコードが簡潔化
- [ ] 実装コードが読みやすい
- [ ] 重複が排除されている
- [ ] すべてのテストがグリーン
- [ ] 品質ゲート合格

---

### ステップ 10: 完了判定

目的: 実装が完全に完了したことを確認。

実行内容:
以下の条件をすべて満たしているか確認:

1. **テスト完了**
   - すべてのテストケースが実装済み
   - すべてのテストがグリーン状態

2. **品質ゲート合格**
   - Lint チェック: 合格
   - 型チェック: 合格
   - その他プロジェクト固有のチェック: すべて合格

3. **Refactor 完了**
   - テストコード・実装コードの整理が完了
   - ユーザーが内容に承認

4. **進捗記録完了**
   - tasks.md がすべての完了タスクをマーク済み
   - セッションが次のタスク ID に更新済み

完了条件チェック:

- [ ] すべてのテストが `passed` 状態
- [ ] Lint チェック合格
- [ ] 型チェック合格
- [ ] テストコード Refactor 完了
- [ ] 実装コード Refactor 完了
- [ ] ユーザー承認取得
- [ ] tasks.md 完全更新
- [ ] セッション更新完了

判定結果:

- YES: 実装完了 → プロセス終了
- NO: ステップ 9 へ戻り、不足部分をリファクタリング
