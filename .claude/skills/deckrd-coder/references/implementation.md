---
title: IMPLEMENTATION - 厳格な実装フロー
---

## IMPLEMENTATION - 厳格な実装フロー

## 全体フロー概要

BDD 実装は以下の 8 ステップで構成されます。各ステップは順序通り実行し、スキップ不可。

```text
Step 1: 品質ゲート用コマンド取得
    ↓
Step 2: 実装タスクリスト取得
    ↓
Step 3-4: BDD サイクル (タスク完了まで繰り返し)
    ├─ Step 3: deckrd-bdd-coder で単一タスク実装
    └─ Step 4: 繰り返し判定
    ↓
Step 5: 品質ゲート実行 (Lint + 型チェック)
    ↓
Step 6: タスクリスト更新
    ↓
Step 7: Refactor フェーズ
    ↓
Step 8: 完了判定
```

---

## 詳細ステップ

### ステップ 1: 品質ゲート用のコマンドを取得する

目的: プロジェクト固有の品質ゲートコマンドを事前に取得。

実行内容:

1. `package.json` / `setup.py` / `Cargo.toml` などをもとに、以下のコマンドを取得
   - Lint チェック: `npm run lint` / `python -m flake8` など
   - 型チェック: `tsc --noEmit` / `mypy` / `pyright` など
   - テスト実行: `npm run test` / `pytest` など
2. 各コマンドが実行可能であることを確認
3. 取得したコマンドを後続ステップで使用するため記録

チェックリスト:

- [ ] Lint コマンド確認
- [ ] 型チェックコマンド確認
- [ ] テスト実行コマンド確認

---

### ステップ 2: パラメータをもとに実装タスクリストを取得する

目的: ユーザーの要件から実装タスクを細分化・リスト化。

実行内容:

1. ユーザーから受け取ったパラメータ (要件、仕様など) を分析
2. 要件を単一テストケース単位のタスクに分割
3. 各タスクの依存関係を把握
4. **実装タスクリスト** を作成

実装タスクリスト例:

```markdown
- [ ] Task 1: 入力値が有効な場合、結果 A を返す (正常系)
- [ ] Task 2: 入力値が null の場合、エラーを返す (異常系)
- [ ] Task 3: 入力値が空文字列の場合、デフォルト値を返す (エッジケース)
```

チェックリスト:

- [ ] タスクが十分に細分化されている (1 test = 1 task の原則)
- [ ] 各タスクは独立している
- [ ] 依存関係が明確

---

### ステップ 3: 実装タスクリストからタスクを 1 つ取りだし、deckrd-bdd-coder で実装する

目的: 単一タスクに対して BDD 厳格プロセスで実装。

実行内容:

1. 実装タスクリストから **最初の未実装タスク** を取り出す
2. **deckrd-bdd-coder エージェント** を起動
   - パラメータ: 対象タスクの詳細説明
   - エージェントが Red-Green-Refactor サイクルを自動実行
3. deckrd-bdd-coder は以下を保証
   - Red フェーズ: テスト実装 → テスト失敗確認
   - Green フェーズ: 最小実装 → テスト合格確認
   - Refactor フェーズ: 軽微な整理 (この段階ではユーザー相談なし)
   - 品質ゲート確認: Lint・型チェックで合格確認

重要な制約:

- deckrd-bdd-coder は **1 つのタスク専用** (複数タスク並行実行禁止)
- deckrd-bdd-coder の処理完了条件: **品質ゲート合格**
- deckrd-bdd-coder でエラー 3 回以上の場合、ロールバック・ユーザー相談

チェックリスト:

- [ ] deckrd-bdd-coder が起動された
- [ ] Red フェーズが完了 (テスト失敗確認)
- [ ] Green フェーズが完了 (テスト合格確認)
- [ ] Refactor (軽微) が完了
- [ ] 品質ゲート合格確認

---

### ステップ 4: 実装タスクリストがなくなるまで、ステップ 3 を繰り返す

目的: すべてのタスクを実装完了。

実行内容:

1. 実装タスクリストを確認
2. 未実装タスクが存在するか判定
   - YES: ステップ 3 に戻る (次のタスクを実装)
   - NO: ステップ 5 へ進む

チェックリスト:

- [ ] すべてのタスクが `completed` 状態
- [ ] 未実装タスクなし

---

### ステップ 5: 品質ゲートを実行する (全体検証)

目的: 全体コードの品質を検証。

実行内容:

1. ステップ 1 で取得したコマンドを実行
   - Lint チェック: `npm run lint` など
   - 型チェック: `tsc --noEmit` など
2. 各チェックの結果を確認
3. 失敗時の対応:
   - エラーの種類・箇所を特定
   - 対応方法を検討・修正
   - 修正後、Step 5 を再実行
   - 必要に応じて Step 7 (Refactor フェーズ) へ戻る
   - 3 回以上失敗時: ユーザーに相談

チェックリスト:

- [ ] Lint チェック: 合格
- [ ] 型チェック: 合格
- [ ] テスト実行: すべてのテストがグリーン
- [ ] 品質ゲート: 全体合格

---

### ステップ 6: 状態確定と進捗記録

目的: 実装状況を明確に記録。

状態確定とは、タスク完了の事実を確認し (実装済みタスクをチェック)、TodoWrite で同期し、次タスクに進んでよい状態であることを明示するフェーズです。

実行内容:

1. 実装タスクリストを確認
2. **各完了タスク** に対して `[x]` (チェック済み) に更新
3. TodoWrite で進捗を同期

更新例:

```markdown
- [x] Task 1: 入力値が有効な場合、結果 A を返す (正常系)
- [x] Task 2: 入力値が null の場合、エラーを返す (異常系)
- [x] Task 3: 入力値が空文字列の場合、デフォルト値を返す (エッジケース)
```

チェックリスト:

- [ ] すべての完了タスクがチェック済み
- [ ] TodoWrite に反映済み

---

### ステップ 7: Refactor フェーズ (全体コード整理)

目的: テストコード・実装コードの読みやすさと簡潔性を向上。

実行内容:

1. **テストコードの整理**
   - テスト仕様化 (it.each など) による簡潔化
   - 重複テストの統合
   - テスト内の変数名・構造改善

2. **実装コードの整理**
   - 重複ロジックの関数抽出
   - 変数名・関数名の改善
   - 不要なコードの削除
   - 読みやすさと簡潔性のバランス最適化

3. **ユーザーとのやりとり**
   - リファクタリング案を提示
   - ユーザーの承認を得る
   - ユーザーの要望に応じて修正

4. **検証**
   - リファクタリング後、すべてのテストが合格することを確認
   - 品質ゲートが合格することを確認

チェックリスト:

- [ ] テストコードが簡潔化
- [ ] 実装コードが読みやすい
- [ ] 重複が排除されている
- [ ] すべてのテストがグリーン
- [ ] 品質ゲート合格

---

### ステップ 8: 完了判定

目的: 実装が完了したことを確認。

実行内容:
以下の条件をすべて満たしているか確認:

1. **テスト完了**
   - すべてのテストケースが実装済み
   - すべてのテストがグリーン状態

2. **品質ゲート合格**
   - Lint チェック: 合格
   - 型チェック: 合格
   - その他プロジェクト固有のチェック: すべて合格

3. **Refactor 完了**
   - テストコード・実装コードの整理が完了
   - ユーザーが内容に承認

完了条件チェック:

- [ ] すべてのテストが `passed` 状態
- [ ] Lint チェック合格
- [ ] 型チェック合格
- [ ] テストコード Refactor 完了
- [ ] 実装コード Refactor 完了
- [ ] ユーザー承認取得

判定結果:

- YES: 実装完了 → プロセス終了
- NO: ステップ 7 へ戻り、不足部分をリファクタリング

---

## 核心原則 (まとめ)

1. ステップ順序の厳密性: 1→2→3→4→5→6→7→8 の順序でスキップ不可
2. 単一タスク原則: deckrd-bdd-coder は 1 タスク専用 (並行実行禁止)
3. 最小実装の遵守: Green フェーズは過剰実装禁止
4. 品質ゲート必須: ステップ 5 実施は必須 (3回以上失敗時、ユーザーに相談)
5. Refactor の不可欠性: ステップ 7 でコード品質を統合的に改善
6. 完了条件の明確性: ステップ 8 のすべてのチェック項目を満たす必要あり
